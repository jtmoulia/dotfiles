#!/usr/bin/env bash
LAYER_DIR=${LAYER_DIR:-layers/common}
HOME_DIR="$LAYER_DIR/HOME"

show_diff=false
while [[ "$1" ]]; do
    case "$1" in
        -h|--diff)
            show_diff=true
            shift
            ;;
        *)
            echo "Unexpected argument: $1"
            exit 1
            ;;
    esac
done

function dodiff() {
    cmp --silent "$1" "$2"
    cmp_status=$?
    if [[ $cmp_status -eq 1 ]]; then
        echo "<" "$1"
        echo ">" "$2"
        if [[ "$show_diff" = true ]]; then
            emacsclient -t --eval "(ediff \"$1\" \"$2\")"
        fi
        echo
    fi
}

find "$LAYER_DIR" -path "$HOME_DIR" -prune -o -type f -print0 | while IFS= read -r -d $'\0' layer_file; do
    sys_file=${layer_file#$LAYER_DIR}
    dodiff "$layer_file" "$sys_file"
done

find "$HOME_DIR" -type f -print0 | while IFS= read -r -d $'\0' layer_file; do
    sys_file="$HOME${layer_file#$HOME_DIR}"
    dodiff "$layer_file" "$sys_file"
done
